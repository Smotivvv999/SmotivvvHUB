local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
   Name = "m4r_marskieee",
   Icon = 0,
   LoadingTitle = "loading autofarm.....",
   LoadingSubtitle = "by marskieee_ganzzz",
   ShowText = "Autofarm",
   Theme = "Default",
   ToggleUIKeybind = "K",
   DisableRayfieldPrompts = false,
   DisableBuildWarnings = false,
   ConfigurationSaving = {
      Enabled = true,
      FolderName = nil,
      FileName = "AutofarmHub"
   },
   Discord = {
      Enabled = false,
      Invite = "noinvitelink",
      RememberJoins = true
   },
   KeySystem = true,
   KeySettings = {
      Title = "Untitled",
      Subtitle = "Key System",
      Note = "No method of obtaining the key is provided",
      FileName = "Key",
      SaveKey = true,
      GrabKeyFromSite = false,
      Key = {"123"}
   }
})

local StatsTab = Window:CreateTab("Stats", "activity")
local FarmTab = Window:CreateTab("Autofarm", "truck")
local SettingsTab = Window:CreateTab("Configuration", "settings")

-- Services
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local TweenService = game:GetService("TweenService")
local Vim = game:GetService("VirtualInputManager")

-- GUI Path for Money Display
local gui = player:WaitForChild("PlayerGui")
local main = gui:WaitForChild("Main")
local container = main:WaitForChild("Container")
local hub = container:WaitForChild("Hub")
local cashFrame = hub:WaitForChild("CashFrame")
local frame = cashFrame:WaitForChild("Frame")
local cashLabel = frame:WaitForChild("TextLabel")

-- Function to parse money from string (handles commas)
local function parseMoney(text)
    if not text then return 0 end
    local cleaned = string.gsub(text, "[^%d]", "")  -- Remove non-digits
    return tonumber(cleaned) or 0
end

-- Function to format numbers as Rupiah (e.g., Rp 1.000.000)
local function formatRupiah(amount)
    local str = tostring(math.floor(amount))
    local formatted = str:reverse():gsub("(%d%d%d)", "%1."):reverse():gsub("^%.", "")
    return "Rp " .. formatted
end

-- Paragraphs for Stats
local MoneyParagraph = StatsTab:CreateParagraph({
    Title = "Total Money",
    Content = "Loading..."
})

local MoneyReceivedParagraph = StatsTab:CreateParagraph({
    Title = "Money Received (Last Cycle)",
    Content = "Rp 0"
})

local TotalEarningParagraph = StatsTab:CreateParagraph({
    Title = "Total Earning",
    Content = "Rp 0"
})

local ElapsedTimeParagraph = StatsTab:CreateParagraph({
    Title = "Elapsed Time",
    Content = "00:00:00"
})

-- Update Money Function
local function updateMoney()
    if cashLabel then
        MoneyParagraph:Set({
            Title = "Total Money",
            Content = cashLabel.Text
        })
    end
end

-- Initial Update and Connect to Changes
updateMoney()
cashLabel:GetPropertyChangedSignal("Text"):Connect(updateMoney)

-- Player and Variables
local CarName = player.Name .. "sCar"
local lastJobFireTime = 0
local JOB_FIRE_COOLDOWN = 5  -- Increased cooldown for stability

-- Stats Tracking Variables
local startTime = 0
local initialMoney = 0
local lastMoney = 0
local totalEarning = 0
local moneyReceived = 0

-- Settings (with UI Text Boxes) - Adjusted defaults for slower, more stable operation
local teleportDelay = 15  -- Adjusted to requested default
local cycleDelay = 0.2    -- Adjusted to requested default
local tweenSpeedMultiplier = 0.9  -- Increased to make tweens slower

local TeleportInput = SettingsTab:CreateInput({
    Name = "Teleport Delay (Seconds)",
    PlaceholderText = "Enter seconds (e.g., 40)",
    Numeric = true,
    CurrentValue = tostring(teleportDelay),
    Flag = "TeleportDelay",
    Callback = function(Value)
        local num = tonumber(Value)
        if num and num >= 10 then  -- Minimum increased
            teleportDelay = num
        else
            print("Invalid input for Teleport Delay. Must be a number >= 10.")
        end
    end,
})

local CycleInput = SettingsTab:CreateInput({
    Name = "Cycle Delay (Seconds)",
    PlaceholderText = "Enter seconds (e.g., 0.3)",
    Numeric = true,
    CurrentValue = tostring(cycleDelay),
    Flag = "CycleDelay",
    Callback = function(Value)
        local num = tonumber(Value)
        if num and num >= 0.3 then  -- Minimum increased
            cycleDelay = num
        else
            print("Invalid input for Cycle Delay. Must be a number >= 0.3.")
        end
    end,
})

local SpeedInput = SettingsTab:CreateInput({
    Name = "Tween Speed Multiplier",
    PlaceholderText = "Enter multiplier (e.g., 1.2)",
    Numeric = true,
    CurrentValue = tostring(tweenSpeedMultiplier),
    Flag = "SpeedMultiplier",
    Callback = function(Value)
        local num = tonumber(Value)
        if num and num >= 1.0 then  -- Minimum increased to ensure slower tweens
            tweenSpeedMultiplier = num
        else
            print("Invalid input for Tween Speed Multiplier. Must be a number >= 1.0.")
        end
    end,
})

-- Functions (optimized for stability)
local function FireJobIfNeeded()
    if tick() - lastJobFireTime > JOB_FIRE_COOLDOWN then
        pcall(function()
            game.ReplicatedStorage.NetworkContainer.RemoteEvents.Job:FireServer("Truck")
        end)
        lastJobFireTime = tick()
    end
end

local function CountdownTeleport(seconds)
    for remaining = seconds, 1, -1 do
        print("Teleporting in " .. remaining .. " seconds...")
        task.wait(1)
    end
end

local function TweenToJob()
    FireJobIfNeeded()
    local Root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if not Root then return end

    local tweenUp = TweenService:Create(Root, TweenInfo.new(0.6 / tweenSpeedMultiplier, Enum.EasingStyle.Quad), {CFrame = Root.CFrame + Vector3.new(0, 100, 0)})
    tweenUp:Play()
    tweenUp.Completed:Wait()

    local tweenTo = TweenService:Create(Root, TweenInfo.new(1 / tweenSpeedMultiplier, Enum.EasingStyle.Quad), {CFrame = CFrame.new(34938.02, 134.51, -54577.36)})
    tweenTo:Play()
    tweenTo.Completed:Wait()

    Root.Anchored = true
    task.wait(0.2)
    Root.Anchored = false
    task.wait(cycleDelay)
end

local function TakingJob()
    local timeout = 1500  -- Increased timeout for stability
    local startTime = tick()
    repeat
        local Root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
        local Waypoint = workspace.Etc.Waypoint:FindFirstChild("Waypoint")
        local Label = Waypoint and Waypoint:FindFirstChild("BillboardGui") and Waypoint.BillboardGui:FindFirstChild("TextLabel")

        if Root then Root.Anchored = true end

        if Label and Label.Text ~= "PT CDID Cargo Malang" then
            FireJobIfNeeded()
            local Prompt = workspace.Etc.Job.Truck.Starter:FindFirstChildWhichIsA("ProximityPrompt", true)
            if Prompt then
                Prompt.MaxActivationDistance = 8
                -- Spam the proximity prompt to increase chances of taking the job
                for i = 1, 10 do  -- Fire the prompt 10 times with short delays
                    fireproximityprompt(Prompt)
                    task.wait(0.1)  -- Short delay between spams
                end
            end
        end

        if Root then Root.Anchored = false end
        task.wait(cycleDelay)
    until (Label and Label.Text == "PT CDID Cargo Malang") or (tick() - startTime > timeout)

    if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        player.Character.HumanoidRootPart.Anchored = false
    end
end

local function SpawningTruck()
    local Root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if not Root then return end
    Root.CFrame = CFrame.new(35163.45, 134.51, -54686.68)
    task.wait(2.0 / cycleDelay)  -- Adjusted wait

    Vim:SendKeyEvent(true, "F", false, game)
    task.wait(0.5 / cycleDelay)  -- Increased wait
    Vim:SendKeyEvent(false, "F", false, game)
    task.wait(2.5 / cycleDelay)  -- Increased wait

    local Car = workspace.Vehicles:FindFirstChild(CarName)
    local Hum = player.Character and player.Character:FindFirstChild("Humanoid")
    local Seat = Car and Car:FindFirstChild("DriveSeat")

    if Hum and Seat then
        pcall(function() Seat:Sit(Hum) end)
        task.wait(0.5 / cycleDelay)  -- Increased wait
        Vim:SendKeyEvent(true, "Space", false, game)
        task.wait(0.1 / cycleDelay)
        Vim:SendKeyEvent(false, "Space", false, game)
    end

    local Trailer = Car and Car:FindFirstChild("Trailer1")
    if Trailer then Trailer:Destroy() end
end

local function MovingCharacterToDestination(Destination)
    local Root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    local Car = workspace.Vehicles:FindFirstChild(CarName)
    if not (Root and Car) then return end

    if not Car.PrimaryPart then
        for _, Part in ipairs(Car:GetDescendants()) do
            if Part:IsA("BasePart") then
                Car.PrimaryPart = Part
                break
            end
        end
    end

    Root.Anchored = true
    if Car.PrimaryPart then Car.PrimaryPart.Anchored = false end

    local follow = true
    task.spawn(function()
        while follow and Car.PrimaryPart and Root do
            local direction = (Root.Position - Car.PrimaryPart.Position)
            if direction.Magnitude > 2 then
                local newPos = Root.Position - direction.Unit * 8
                Car:PivotTo(CFrame.new(newPos, Root.Position))
            end
            task.wait(0.15)  -- Slightly increased wait for stability
        end
    end)

    local tween1 = TweenService:Create(Root, TweenInfo.new(2.5 / tweenSpeedMultiplier, Enum.EasingStyle.Quad), {CFrame = Root.CFrame + Vector3.new(0, 100, 0)})  -- Increased time
    tween1:Play()
    tween1.Completed:Wait()

    local tween2 = TweenService:Create(Root, TweenInfo.new(4.5 / tweenSpeedMultiplier, Enum.EasingStyle.Sine), {CFrame = CFrame.new(Destination.Position + Vector3.new(0, 100, 0))})  -- Increased time
    tween2:Play()
    tween2.Completed:Wait()

    local tween3 = TweenService:Create(Root, TweenInfo.new(2.0 / tweenSpeedMultiplier, Enum.EasingStyle.Exponential), {CFrame = Destination})  -- Increased time
    tween3:Play()
    tween3.Completed:Wait()

    follow = false
    task.wait(0.3)  -- Increased wait
    Root.Anchored = false
    if Car.PrimaryPart then Car.PrimaryPart.Anchored = false end
end

local function SitInVehicle()
    local Car = workspace.Vehicles:FindFirstChild(CarName)
    local Hum = player.Character and player.Character:FindFirstChild("Humanoid")
    local Seat = Car and Car:FindFirstChild("DriveSeat")
    if Hum and Seat then pcall(function() Seat:Sit(Hum) end) end
end

local function CarTween(TargetCFrame)
    local Root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if not Root then return end
    Root.Anchored = false
    task.wait(0.5 / cycleDelay)  -- Increased wait

    local Car = workspace.Vehicles:FindFirstChild(CarName)
    if not Car then return end
    if not Car.PrimaryPart then
        local Seat = Car:FindFirstChild("DriveSeat")
        if Seat then Car.PrimaryPart = Seat else return end
    end

    local Temp = Instance.new("CFrameValue", workspace)
    Temp.Value = Car:GetPivot()
    Temp:GetPropertyChangedSignal("Value"):Connect(function()
        Car:PivotTo(Temp.Value)
    end)

    local Tween = TweenService:Create(Temp, TweenInfo.new(4 / tweenSpeedMultiplier, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), {Value = TargetCFrame})  -- Increased time
    Tween:Play()
    Tween.Completed:Wait()
    Temp:Destroy()

    FireJobIfNeeded()
    task.wait(0.5 / cycleDelay)  -- Increased wait
    Root.Anchored = true
    task.wait(0.5 / cycleDelay)  -- Increased wait
    Root.Anchored = false
end
-- Function to format elapsed time as HH:MM:SS
local function formatTime(seconds)
    local hours = math.floor(seconds / 3600)
    local mins = math.floor((seconds % 3600) / 60)
    local secs = math.floor(seconds % 60)
    return string.format("%02d:%02d:%02d", hours, mins, secs)
end

-- Update Stats Function
local function updateStats()
    local currentMoney = parseMoney(cashLabel.Text)
    moneyReceived = currentMoney - lastMoney
    totalEarning = totalEarning + moneyReceived
    lastMoney = currentMoney

    MoneyReceivedParagraph:Set({
        Title = "Money Received (Last Cycle)",
        Content = formatRupiah(moneyReceived)
    })

    TotalEarningParagraph:Set({
        Title = "Total Earning",
        Content = formatRupiah(totalEarning)
    })
end

-- Autofarm Toggle
local autofarmActive = false
local AutoFarmToggle = FarmTab:CreateToggle({
    Name = "Start Autofarm (~1B / 10 Minutes)",
    CurrentValue = false,
    Flag = "AutoFarmToggle",
    Callback = function(Value)
        autofarmActive = Value
        if autofarmActive then
            startTime = tick()
            initialMoney = parseMoney(cashLabel.Text)
            lastMoney = initialMoney
            totalEarning = 0
            moneyReceived = 0
            task.spawn(function()
                while autofarmActive do
                    pcall(TweenToJob)
                    task.wait(cycleDelay)
                    pcall(TakingJob)
                    task.wait(cycleDelay)

                    -- Check if the job destination is correct before spawning truck
                    local Waypoint = workspace.Etc.Waypoint:FindFirstChild("Waypoint")
                    local Label = Waypoint and Waypoint:FindFirstChild("BillboardGui") and Waypoint.BillboardGui:FindFirstChild("TextLabel")
                    if Label and Label.Text == "PT CDID Cargo Malang" then
                        pcall(SpawningTruck)
                        task.wait(cycleDelay)
                        pcall(MovingCharacterToDestination, CFrame.new(-7916.433, 385.897, 46837.558))
                        task.wait(cycleDelay)
                        pcall(CountdownTeleport, teleportDelay)
                        pcall(SitInVehicle)
                        task.wait(cycleDelay)
                        pcall(CarTween, CFrame.new(-7846.73, 386.41, 46865.10))
                        task.wait(cycleDelay)
                        -- Update stats after each cycle
                        updateStats()
                    else
                        print("Job not taken correctly, skipping truck spawn and delivery.")
                        task.wait(1)  -- Increased wait before retrying
                    end
                end
            end)
        end
    end,
})

-- Status Paragraph
local StatusParagraph = FarmTab:CreateParagraph({
    Title = "Status",
    Content = "Idle"
})

-- Update Status and Elapsed Time in real-time
task.spawn(function()
    while true do
        if autofarmActive then
            local elapsed = tick() - startTime
            ElapsedTimeParagraph:Set({
                Title = "Elapsed Time",
                Content = formatTime(elapsed)
            })
            StatusParagraph:Set({
                Title = "Status",
                Content = "Autofarm Running"
            })
        else
            StatusParagraph:Set({
                Title = "Status",
                Content = "Idle"
            })
            ElapsedTimeParagraph:Set({
                Title = "Elapsed Time",
                Content = "00:00:00"
            })
        end
        task.wait(1)
    end
end)
