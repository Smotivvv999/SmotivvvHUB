-- Load Rayfield
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
   Name = "Rayfield Example Window",
   Icon = 0,
   LoadingTitle = "Rayfield Interface Suite",
   LoadingSubtitle = "by Sirius",
   ShowText = "Rayfield",
   Theme = "Default",
   ToggleUIKeybind = "K",
   DisableRayfieldPrompts = false,
   DisableBuildWarnings = false,
   ConfigurationSaving = {
      Enabled = true,
      FolderName = nil,
      FileName = "Big Hub"
   },
})

local Tab = Window:CreateTab("Stats", "trending-up")
local Section = Tab:CreateSection("Farm Stats")

-- Simpan referensi ke paragraph untuk update realtime
local AutofarmStatsPara = Tab:CreateParagraph({Title = "Autofarm Stats", Content = "Idle"})
local WaitingTeleportPara = Tab:CreateParagraph({Title = "Waiting Teleport", Content = "Not waiting"})
local ElapsedTimePara = Tab:CreateParagraph({Title = "Elapsed Time", Content = "00:00:00"})

local Section = Tab:CreateSection("Earn Stats")  

-- Fungsi untuk format Rupiah
local function formatRupiah(amount)
    if not amount or amount == 0 then return "Rp 0" end
    local formatted = string.format("%.0f", amount)
    formatted = formatted:reverse():gsub("(%d%d%d)", "%1."):reverse()
    return "Rp " .. formatted:gsub("^,", "")
end

-- Variabel untuk tracking stats
local totalMoney = 0
local moneyReceived = 0
local moneyIncome = 0
local startTime = tick()
local lastMoney = 0

-- Paragraf untuk stats
local totalMoneyPara = Tab:CreateParagraph({Title="Total Money", Content="Rp 0"})
local moneyReceivedPara = Tab:CreateParagraph({Title="Total Earning", Content="Rp 0"})  -- Diubah dari "Money Received" ke "Total Earning"
local moneyIncomePara = Tab:CreateParagraph({Title="Money Income", Content="Rp 0 / Hour"})

-- Fungsi update stats
local function updateStats()
    local currentMoneyText = game:GetService("Players").LocalPlayer.PlayerGui.Main.Container.Hub.CashFrame.Frame.TextLabel.Text
    
    -- Parsing lebih robust: hapus semua non-digit
    local cleanedText = currentMoneyText:gsub("[^%d]", "")  -- Hapus semua karakter non-digit
    local currentMoney = tonumber(cleanedText) or 0
    
    totalMoney = currentMoney
    totalMoneyPara:Set({Title="Total Money", Content=formatRupiah(totalMoney)})
    
    -- Hitung money received (selisih positif)
    if currentMoney > lastMoney then
        moneyReceived = moneyReceived + (currentMoney - lastMoney)
    end
    lastMoney = currentMoney
    moneyReceivedPara:Set({Title="Total Earning", Content=formatRupiah(moneyReceived)})  -- Diubah dari "Money Received" ke "Total Earning"
    
    -- Hitung money income (per hour)
    local elapsedTime = tick() - startTime
    if elapsedTime > 0 then
        moneyIncome = (moneyReceived / elapsedTime) * 3600  -- Konversi ke per jam
    end
    moneyIncomePara:Set({Title="Money Income", Content=formatRupiah(moneyIncome) .. " / Hour"})
end

-- Update stats awal
updateStats()

-- Connect ke perubahan money
game:GetService("Players").LocalPlayer.PlayerGui.Main.Container.Hub.CashFrame.Frame.TextLabel.Changed:Connect(function()
    updateStats()
end)

-- Loop update stats setiap detik untuk income yang akurat
task.spawn(function()
    while true do
        task.wait(1)
        updateStats()
    end
end)

local Tab = Window:CreateTab("Configuration", "settings")
local Section = Tab:CreateSection("Set tele & recall job")

local Paragraph = Tab:CreateParagraph({
    Title = "Set Config Working",
    Content = [[
Teleport: 18 detik
Recall Job: 0.5
]]
})

-- Variabel untuk menyimpan nilai dari input
local recallJobTime = 0.5
local teleportTime = 18

local Input = Tab:CreateInput({
   Name = "Teleport",
   CurrentValue = "18",
   PlaceholderText = "Input teleport time in seconds",
   RemoveTextAfterFocusLost = false,
   Flag = "TeleportInput",
   Callback = function(Text)
       teleportTime = tonumber(Text) or 20
       print("Teleport time set to: " .. teleportTime)
   end,
})

local Input = Tab:CreateInput({
   Name = "Recall job",
   CurrentValue = "0.5",
   PlaceholderText = "Input recall job time in seconds",
   RemoveTextAfterFocusLost = false,
   Flag = "RecallJobInput",
   Callback = function(Text)
       recallJobTime = tonumber(Text) or 0.3
       print("Recall job time set to: " .. recallJobTime)
   end,
})

local Tab = Window:CreateTab("Autofarm", "plane-takeoff")
local Section = Tab:CreateSection("Executor Stats")

-- Fungsi untuk mendeteksi executor dengan lebih banyak checks
local function getExecutor()
    local executor = "Unknown"
    local version = ""
    
    -- Coba identifyexecutor() terlebih dahulu
    if identifyexecutor then
        pcall(function()
            executor = identifyexecutor()
        end)
    end
    
    -- Jika masih unknown, cek variabel global
    if executor == "Unknown" then
        if syn then
            executor = "Synapse X"
            if syn.version then version = " v" .. syn.version end
        elseif krnl then
            executor = "Krnl"
        elseif fluxus then
            executor = "Fluxus"
        elseif scriptware then
            executor = "Delta"
        elseif xeno then
            executor = "Xeno"
            if xeno.version then version = " v" .. xeno.version end
        elseif getgenv then
            -- Jika getgenv ada tapi tidak spesifik, coba deteksi lain
            executor = "Unknown (getgenv detected)"
        elseif hookfunction then
            executor = "Unknown (hookfunction detected)"
        end
    end
    
    -- Gabungkan executor dan versi
    if version ~= "" then
        return executor .. version
    else
        return executor
    end
end

local Paragraph = Tab:CreateParagraph({Title = "Executor", Content = getExecutor()})

local Section = Tab:CreateSection("Autofarm [CAR DRIVING INDONESIA]")

local Input = Tab:CreateInput({
   Name = "Webhoks url",
   CurrentValue = "",
   PlaceholderText = "Input Placeholder",
   RemoveTextAfterFocusLost = false,
   Flag = "Input1",
   Callback = function(Text)
   -- The function that takes place when the input is changed
   -- The variable (Text) is a string for the value in the text box
   end,
})

local Section = Tab:CreateSection("Autofarm [CAR DRIVING INDONESIA]")

local Player = game.Players.LocalPlayer
local CarName = Player.Name .. "sCar"
local TweenService = game:GetService("TweenService")
local Vim = game:GetService("VirtualInputManager")

-- Variabel untuk autofarm
local autofarmActive = false
local autofarmStartTime = 0

-- Fungsi untuk format waktu elapsed (HH:MM:SS)
local function formatElapsedTime(seconds)
    local hours = math.floor(seconds / 3600)
    local minutes = math.floor((seconds % 3600) / 60)
    local secs = math.floor(seconds % 60)
    return string.format("%02d:%02d:%02d", hours, minutes, secs)
end

-- Fungsi update elapsed time
local function updateElapsedTime()
    if autofarmActive then
        local elapsed = tick() - autofarmStartTime
        ElapsedTimePara:Set({Title = "Elapsed Time", Content = formatElapsedTime(elapsed)})
    else
        ElapsedTimePara:Set({Title = "Elapsed Time", Content = "00:00:00"})
    end
end

-- Fungsi tween teleport ke area kerja
function TweenToJob()
    if not autofarmActive then return end
    AutofarmStatsPara:Set({Title = "Autofarm Stats", Content = "Menuju lokasi job..."})
    pcall(function()
        game.ReplicatedStorage.NetworkContainer.RemoteEvents.Job:FireServer("Truck")
        
        local Root = Player.Character:FindFirstChild("HumanoidRootPart")
        if not Root then return end

        TweenService:Create(Root, TweenInfo.new(1.0, Enum.EasingStyle.Quad), {
            CFrame = Root.CFrame + Vector3.new(0, 100, 0)
        }):Play()

        task.wait(1.0)
        TweenService:Create(Root, TweenInfo.new(2.0, Enum.EasingStyle.Quad), {
            CFrame = CFrame.new(34938.02, 134.51, -54577.36)
        }):Play()

        task.wait(2.0)
        TweenService:Create(Root, TweenInfo.new(2.0, Enum.EasingStyle.Exponential), {
            CFrame = CFrame.new(34938.02, 134.51, -54577.36)
        }):Play()

        task.wait(2.0)
        Root.Anchored = true
        task.wait(0.8)
        Root.Anchored = false
    end)
end

-- Fungsi mengambil job "Truck" dengan timeout anti-stuck
function TakingJob()
    if not autofarmActive then return end
    AutofarmStatsPara:Set({Title = "Autofarm Stats", Content = "Sedang eksekusi pekerjaan..."})
    local attempts = 0
    local maxAttempts = 50  -- Timeout after ~15 seconds (50 * 0.3)
    repeat
        if not autofarmActive then return end
        attempts = attempts + 1
        if attempts > maxAttempts then
            warn("TakingJob stuck, skipping...")
            return
        end
        pcall(function()
            local Root = Player.Character:FindFirstChild("HumanoidRootPart")
            local Waypoint = workspace.Etc.Waypoint:FindFirstChild("Waypoint")
            local Label = Waypoint and Waypoint:FindFirstChild("BillboardGui") and Waypoint.BillboardGui:FindFirstChild("TextLabel")

            if Root then Root.Anchored = true end

            if Label and Label.Text ~= "PT CDID Cargo Malang" then
                game.ReplicatedStorage.NetworkContainer.RemoteEvents.Job:FireServer("Truck")
                local Prompt = workspace.Etc.Job.Truck.Starter:FindFirstChildWhichIsA("ProximityPrompt", true)
                if Prompt then
                    Prompt.MaxActivationDistance = 100000
                    fireproximityprompt(Prompt)
                end
            end

            if Root then Root.Anchored = false end
        end)
        task.wait(0.3)
    until (function()
        local Waypoint = workspace.Etc.Waypoint:FindFirstChild("Waypoint")
        local Label = Waypoint and Waypoint:FindFirstChild("BillboardGui") and Waypoint.BillboardGui:FindFirstChild("TextLabel")
        return Label and Label.Text == "PT CDID Cargo Malang"
    end)()

    pcall(function()
        Player.Character.HumanoidRootPart.Anchored = false
    end)
end

-- Fungsi spawn mobil + langsung duduk + destroy trailer dengan checks
function SpawningTruck()
    if not autofarmActive then return end
    AutofarmStatsPara:Set({Title = "Autofarm Stats", Content = "Menyiapkan truk..."})
    pcall(function()
        local Root = Player.Character and Player.Character:FindFirstChild("HumanoidRootPart")
        if not Root then return end

        Root.CFrame = CFrame.new(35163.45, 134.51, -54686.68)

        task.wait(3.0)
        Vim:SendKeyEvent(true, "F", false, game)
        task.wait(0.3)
        Vim:SendKeyEvent(false, "F", false, game)
        task.wait(3.0)

        local Car = workspace.Vehicles:FindFirstChild(CarName)
        local Humanoid = Player.Character and Player.Character:FindFirstChild("Humanoid")
        local Seat = Car and Car:FindFirstChild("DriveSeat")

        if Humanoid and Seat then
            pcall(function() Seat:Sit(Humanoid) end)
            task.wait(0.8)
            Vim:SendKeyEvent(true, "Space", false, game)
            task.wait(0.1)
            Vim:SendKeyEvent(false, "Space", false, game)
        end

        local Trailer = Car and Car:FindFirstChild("Trailer1")
        if Trailer then
            Trailer:Destroy()
            print("Trailer destroyed to prevent interference.")
        end
    end)
end

-- Fungsi bergerak ke destinasi dengan anti-stuck
function MovingCharacterToDestination(Destination)
    if not autofarmActive then return end
    AutofarmStatsPara:Set({Title = "Autofarm Stats", Content = "Menuju titik tujuan..."})
    pcall(function()
        local Root = Player.Character and Player.Character:FindFirstChild("HumanoidRootPart")
        local Car = workspace.Vehicles:FindFirstChild(CarName)

        if not (Root and Car) then return end

        if not Car.PrimaryPart then
            for _, Part in ipairs(Car:GetDescendants()) do
                if Part:IsA("BasePart") then
                    Car.PrimaryPart = Part
                    break
                end
            end
        end

        Root.Anchored = true
        if Car.PrimaryPart then Car.PrimaryPart.Anchored = true end

        local Follow = true
        local followThread = task.spawn(function()
            while Follow and autofarmActive do
                if Car.PrimaryPart and Root then
                    local offset = (Root.Position - Car.PrimaryPart.Position).Unit * 5
                    local newPos = Root.Position + offset
                    Car:PivotTo(CFrame.new(newPos))
                end
                task.wait(0.3)
            end
        end)

        local AboveStart = Root.CFrame + Vector3.new(0, 100, 0)
        local AboveDest = CFrame.new(Destination.Position + Vector3.new(0, 100, 0))

        local tween1 = TweenService:Create(Root, TweenInfo.new(5.0, Enum.EasingStyle.Quad), {CFrame = AboveStart})
        tween1:Play()
        tween1.Completed:Wait()

        local tween2 = TweenService:Create(Root, TweenInfo.new(8.0, Enum.EasingStyle.Sine), {CFrame = AboveDest})
        tween2:Play()
        tween2.Completed:Wait()

        local tween3 = TweenService:Create(Root, TweenInfo.new(6.0, Enum.EasingStyle.Exponential), {CFrame = Destination})
        tween3:Play()
        tween3.Completed:Wait()

        Follow = false
        task.wait()

        if Car.PrimaryPart then Car.PrimaryPart.Anchored = false end
        Root.Anchored = false
    end)
end

function CountdownTeleport(seconds)
    if not autofarmActive then return end
    WaitingTeleportPara:Set({Title = "Waiting Teleport", Content = "Teleporting in " .. seconds .. " seconds..."})
    for i = seconds, 1, -1 do
        if not autofarmActive then return end
        WaitingTeleportPara:Set({Title = "Waiting Teleport", Content = "Teleporting in " .. i .. " seconds..."})
        task.wait(1)
    end
    WaitingTeleportPara:Set({Title = "Waiting Teleport", Content = "Not waiting"})
end

function SitInVehicle()
    if not autofarmActive then return end
    AutofarmStatsPara:Set({Title = "Autofarm Stats", Content = "Duduk di kendaraan..."})
    pcall(function()
        local Car = workspace.Vehicles:FindFirstChild(CarName)
        local Hum = Player.Character and Player.Character:FindFirstChild("Humanoid")
        local Seat = Car and Car:FindFirstChild("DriveSeat")
        if Hum and Seat then pcall(function() Seat:Sit(Hum) end) end
    end)
end

function CarTween(TargetCFrame)
    if not autofarmActive then return end
    AutofarmStatsPara:Set({Title = "Autofarm Stats", Content = "Melaju ke tujuan..."})
    pcall(function()
        local Root = Player.Character and Player.Character:FindFirstChild("HumanoidRootPart")
        if not Root then return end
        Root.Anchored = false

        task.wait(0.5)

        local Car = workspace.Vehicles:FindFirstChild(CarName)
        if not Car then warn("Vehicle not found.") return end
        if not Car.PrimaryPart then
            local Seat = Car:FindFirstChild("DriveSeat")
            if Seat then Car.PrimaryPart = Seat else return end
        end

        local Temp = Instance.new("CFrameValue", workspace)
        Temp.Value = Car:GetPivot()

        local Tween = game:GetService("TweenService"):Create(Temp, TweenInfo.new(4, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), {
            Value = TargetCFrame
        })

        Temp:GetPropertyChangedSignal("Value"):Connect(function()
            Car:PivotTo(Temp.Value)
        end)

        Tween:Play()
        Tween.Completed:Wait()
        Temp:Destroy()

        game.ReplicatedStorage.NetworkContainer.RemoteEvents.Job:FireServer("Truck")

        task.wait(0.5)
        Root.Anchored = true
        task.wait(0.5)
        Root.Anchored = false
        task.wait(0.1)
    end)
end

-- Toggle Autofarm
local Toggle = Tab:CreateToggle({
   Name = "Start Autofarm",
   CurrentValue = false,
   Flag = "AutofarmToggle",
   Callback = function(Value)
       autofarmActive = Value
       print("Status 'auto farm' diatur ke: " .. tostring(autofarmActive))

       if autofarmActive then
           -- Reset stats saat mulai autofarm
           moneyReceived = 0
           startTime = tick()
           autofarmStartTime = tick()
           lastMoney = totalMoney
           updateStats()
           AutofarmStatsPara:Set({Title = "Autofarm Stats", Content = "Starting Autofarm"})
           WaitingTeleportPara:Set({Title = "Waiting Teleport", Content = "Not waiting"})
           
           -- Loop update elapsed time setiap detik
           task.spawn(function()
               while autofarmActive do
                   updateElapsedTime()
                   task.wait(1)
               end
           end)
           
           task.spawn(function()
               print("Proses auto farm dimulai... Target: 5B/Hour")
               
               while autofarmActive do
                   if not autofarmActive then break end
                   TweenToJob()
                   task.wait(recallJobTime)

                   if not autofarmActive then break end
                   TakingJob()
                   task.wait(recallJobTime)

                   if not autofarmActive then break end
                   SpawningTruck()
                   task.wait(recallJobTime)

                   if not autofarmActive then break end
                   MovingCharacterToDestination(CFrame.new(-7916.433, 385.897, 46837.558))
                   task.wait(recallJobTime)

                   if not autofarmActive then break end
                   CountdownTeleport(teleportTime)
                   task.wait(recallJobTime)

                   if not autofarmActive then break end
                   SitInVehicle()
                   task.wait(recallJobTime)
                   
                   if not autofarmActive then break end
                   CarTween(CFrame.new(-7846.73, 386.41, 46865.10)) 
                   task.wait(recallJobTime)
               end
               
               print("Proses auto farm telah dihentikan.")
               AutofarmStatsPara:Set({Title = "Autofarm Stats", Content = "Idle"})
               WaitingTeleportPara:Set({Title = "Waiting Teleport", Content = "Not waiting"})
           end)
       else
           AutofarmStatsPara:Set({Title = "Autofarm Stats", Content = "Idle"})
           WaitingTeleportPara:Set({Title = "Waiting Teleport", Content = "Not waiting"})
       end
   end,
})

-- BUTTON EXIT AUTOFARM (LEAVE GAME)
Tab:CreateButton({
   Name = "Exit Autofarm",
   Callback = function()
       print("Exit Autofarm ditekan")

       -- Matikan autofarm
       autofarmActive = false

       -- Lepaskan anchor
       pcall(function()
           local char = Player.Character
           if char and char:FindFirstChild("HumanoidRootPart") then
               char.HumanoidRootPart.Anchored = false
           end
       end)

       task.wait(0.5)

       -- Keluar dari game Roblox
       game:Shutdown()
   end,
})
